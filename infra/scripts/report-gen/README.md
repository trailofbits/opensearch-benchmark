# Report Generator

## Setup

Install python >= 3.13 and [uv](https://docs.astral.sh/uv/).

You will also need a Google API credentials file. Follow the steps below:

  1. [Create a project](https://developers.google.com/workspace/guides/create-project)
  2. [Enable APIs](https://developers.google.com/workspace/guides/enable-apis). Search for and enable the Google Sheets API
  3. [Configure OAuth Consent](https://developers.google.com/workspace/guides/configure-oauth-consent). Select "Internal" for the user type.
  4. [Create OAth client ID credentials](https://developers.google.com/workspace/guides/create-credentials#oauth-client-id).
  5. Download the created credentials file.

Lastly you will need the URL and password for the shared data store.

## Download Data

The `./download.sh` script can be used to download data generated by CI.

For example to download nightly runs from from 12/01/2024 00:00 to 12/08/2024 00:00

```shell
export DS_URL=<datastore url>
export DS_PASSWORD=<datastore password>
./download.sh --source nightly 2024-12-01 2024-12-08
```

Results will be downloaded to a directory named `download_{source}-{start_date}-{end_date}`.

The script expects the data store URL and password to be in the `DS_URL` and `DS_PASSWORD` environment variables. It takes a source as a flag and a date range as input in the form `YYYY-MM-DD YYYY-MM-DD`

Valid sources are `nightly`, `manual` and `dev`. The type of data downloaded is shown below.

| tag | run type | ci |
| -   | -        | -  |
| `nightly` | official | scheduled |
| `manual` | official | manual |
| `dev` | dev | manual |

## Generate Report

The script `./create_report.sh` will create and upload a google sheet report.

```shell
./create_report.sh download_nightly_2024-12-01_2024-12-08/ /path/to/credentials.json
```

Check your Google Drive home folder for the generated spreadsheet, or click the link outputted to the command line.

If you see `Authentication has failed`, just delete `token.json` and run the script again.

## Generate ES Version Report

Assuming ES versioned runs are executed manually via the CI.

```shell
./download.sh --source manual 2024-10-21 2024-10-29

./create_report.sh download_manual_2024-10-21_2024-10-29/ /path/to/credentials.json
```

## Compare results week-to-week

**NOTE**: This output is used for debugging. It will output a lot of information, so it's best to redirect to a file.

```shell
./diff_report.sh download_nightly_2024-11-11_2024-11-26/ download_nightly_2024-11-18_2024-12-03/
```

## Tests

Running `make test` will run a snapshot test by creating a new spreadsheet from a fixed dataset (`test/data/test_data`) and comparing the generated spreadsheet to previously generated sheets (`test/data/results.csv` and `test/data/summary.csv`).

To run the test, the environment variable `GOOGLE_CRED` should contain the path to the `credentials.json` created above.

The snapshot test only checks that existing behavior is not broken. When modifying the generated sheet you should:

  1. Modify the test to exclude the modifications.
  1. Pass all other tests, ensuring no existing features were broken.
  1. Verify the new features are working correctly.
  1. Update the data and snapshots in `test/data` with the new ground truth.

Ground truth csv's can be downloaded from google drive directly (File -> download -> csv).
